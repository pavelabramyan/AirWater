-- AirWater Postgres: схема + сид (старт: Россия и регионы)
-- Цена воды: средняя для бутилированной воды, 1L, USD

BEGIN;

CREATE TABLE IF NOT EXISTS countries (
    id BIGSERIAL PRIMARY KEY,
    iso2 CHAR(2) UNIQUE,
    iso3 CHAR(3),
    name_ru TEXT NOT NULL,
    name_en TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS regions (
    id BIGSERIAL PRIMARY KEY,
    country_id BIGINT NOT NULL REFERENCES countries(id) ON DELETE CASCADE,
    name_ru TEXT NOT NULL,
    name_en TEXT,
    center_lat DOUBLE PRECISION,
    center_lon DOUBLE PRECISION,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE(country_id, name_ru)
);

CREATE TABLE IF NOT EXISTS region_metrics (
    region_id BIGINT PRIMARY KEY REFERENCES regions(id) ON DELETE CASCADE,
    avg_annual_humidity NUMERIC(5,2),
    avg_water_price_usd_1l NUMERIC(10,4),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Страна: Россия
INSERT INTO countries (iso2, iso3, name_ru, name_en)
VALUES ('RU', 'RUS', 'Россия', 'Russia')
ON CONFLICT (iso2) DO UPDATE
SET iso3 = EXCLUDED.iso3,
    name_ru = EXCLUDED.name_ru,
    name_en = EXCLUDED.name_en;

-- Регионы РФ + метрики (значения синхронизированы с locations.js)
WITH ru AS (
    SELECT id AS country_id FROM countries WHERE iso2 = 'RU'
),
upsert_regions AS (
    INSERT INTO regions (country_id, name_ru, center_lat, center_lon)
    SELECT ru.country_id, v.name_ru, v.lat, v.lon
    FROM ru
    CROSS JOIN (VALUES
        ('Москва', 55.7558, 37.6173),
        ('Московская область', NULL, NULL),
        ('Санкт-Петербург', 59.9311, 30.3609),
        ('Ленинградская область', NULL, NULL),
        ('Севастополь', 44.6167, 33.5254),
        ('Республика Крым', NULL, NULL),
        ('Республика Адыгея', NULL, NULL),
        ('Республика Алтай', NULL, NULL),
        ('Республика Башкортостан', NULL, NULL),
        ('Республика Бурятия', NULL, NULL),
        ('Республика Дагестан', NULL, NULL),
        ('Республика Ингушетия', NULL, NULL),
        ('Кабардино-Балкарская Республика', NULL, NULL),
        ('Республика Калмыкия', NULL, NULL),
        ('Карачаево-Черкесская Республика', NULL, NULL),
        ('Республика Карелия', NULL, NULL),
        ('Республика Коми', NULL, NULL),
        ('Республика Марий Эл', NULL, NULL),
        ('Республика Мордовия', NULL, NULL),
        ('Республика Саха (Якутия)', NULL, NULL),
        ('Республика Северная Осетия — Алания', NULL, NULL),
        ('Республика Татарстан', NULL, NULL),
        ('Республика Тыва', NULL, NULL),
        ('Удмуртская Республика', NULL, NULL),
        ('Республика Хакасия', NULL, NULL),
        ('Чеченская Республика', NULL, NULL),
        ('Чувашская Республика', NULL, NULL),
        ('Алтайский край', NULL, NULL),
        ('Краснодарский край', 45.0355, 38.9753),
        ('Красноярский край', NULL, NULL),
        ('Приморский край', 43.1155, 131.8855),
        ('Ставропольский край', NULL, NULL),
        ('Хабаровский край', NULL, NULL),
        ('Амурская область', NULL, NULL),
        ('Архангельская область', NULL, NULL),
        ('Астраханская область', NULL, NULL),
        ('Белгородская область', NULL, NULL),
        ('Брянская область', NULL, NULL),
        ('Владимирская область', NULL, NULL),
        ('Волгоградская область', NULL, NULL),
        ('Вологодская область', NULL, NULL),
        ('Воронежская область', NULL, NULL),
        ('Ивановская область', NULL, NULL),
        ('Иркутская область', NULL, NULL),
        ('Калининградская область', 54.7104, 20.4522),
        ('Калужская область', NULL, NULL),
        ('Камчатский край', NULL, NULL),
        ('Кемеровская область — Кузбасс', NULL, NULL),
        ('Кировская область', NULL, NULL),
        ('Костромская область', NULL, NULL),
        ('Курганская область', NULL, NULL),
        ('Курская область', NULL, NULL),
        ('Липецкая область', NULL, NULL),
        ('Магаданская область', NULL, NULL),
        ('Мурманская область', NULL, NULL),
        ('Нижегородская область', NULL, NULL),
        ('Новгородская область', NULL, NULL),
        ('Новосибирская область', 55.0084, 82.9357),
        ('Омская область', NULL, NULL),
        ('Оренбургская область', NULL, NULL),
        ('Орловская область', NULL, NULL),
        ('Пензенская область', NULL, NULL),
        ('Пермский край', NULL, NULL),
        ('Псковская область', NULL, NULL),
        ('Ростовская область', 47.2357, 39.7015),
        ('Рязанская область', NULL, NULL),
        ('Самарская область', NULL, NULL),
        ('Саратовская область', NULL, NULL),
        ('Сахалинская область', NULL, NULL),
        ('Свердловская область', 56.8389, 60.6057),
        ('Смоленская область', NULL, NULL),
        ('Тамбовская область', NULL, NULL),
        ('Тверская область', NULL, NULL),
        ('Томская область', NULL, NULL),
        ('Тульская область', NULL, NULL),
        ('Тюменская область', NULL, NULL),
        ('Ульяновская область', NULL, NULL),
        ('Челябинская область', NULL, NULL),
        ('Забайкальский край', NULL, NULL),
        ('Ярославская область', NULL, NULL),
        ('Еврейская автономная область', NULL, NULL),
        ('Ненецкий автономный округ', NULL, NULL),
        ('Ханты-Мансийский автономный округ — Югра', NULL, NULL),
        ('Чукотский автономный округ', NULL, NULL),
        ('Ямало-Ненецкий автономный округ', NULL, NULL),
        ('Донецкая Народная Республика', NULL, NULL),
        ('Луганская Народная Республика', NULL, NULL),
        ('Запорожская область', NULL, NULL),
        ('Херсонская область', NULL, NULL)
    ) AS v(name_ru, lat, lon)
    ON CONFLICT (country_id, name_ru) DO UPDATE
    SET center_lat = EXCLUDED.center_lat,
        center_lon = EXCLUDED.center_lon
    RETURNING id, country_id, name_ru
)
INSERT INTO region_metrics (region_id, avg_annual_humidity, avg_water_price_usd_1l)
SELECT r.id, m.humidity, m.price
FROM upsert_regions r
JOIN (VALUES
    ('Москва', 70, 1.8),
    ('Московская область', 70, 1.5),
    ('Санкт-Петербург', 78, 1.7),
    ('Ленинградская область', 78, 1.3),
    ('Севастополь', 72, 1.4),
    ('Республика Крым', 72, 1.3),
    ('Республика Адыгея', 72, 1.2),
    ('Республика Алтай', 60, 1.2),
    ('Республика Башкортостан', 67, 1.2),
    ('Республика Бурятия', 58, 1.2),
    ('Республика Дагестан', 66, 1.2),
    ('Республика Ингушетия', 66, 1.2),
    ('Кабардино-Балкарская Республика', 66, 1.2),
    ('Республика Калмыкия', 55, 1.2),
    ('Карачаево-Черкесская Республика', 66, 1.2),
    ('Республика Карелия', 78, 1.2),
    ('Республика Коми', 78, 1.2),
    ('Республика Марий Эл', 72, 1.2),
    ('Республика Мордовия', 70, 1.2),
    ('Республика Саха (Якутия)', 60, 1.2),
    ('Республика Северная Осетия — Алания', 66, 1.2),
    ('Республика Татарстан', 70, 1.2),
    ('Республика Тыва', 55, 1.2),
    ('Удмуртская Республика', 72, 1.2),
    ('Республика Хакасия', 55, 1.2),
    ('Чеченская Республика', 66, 1.2),
    ('Чувашская Республика', 70, 1.2),
    ('Алтайский край', 60, 1.2),
    ('Краснодарский край', 75, 1.4),
    ('Красноярский край', 60, 1.2),
    ('Приморский край', 78, 1.3),
    ('Ставропольский край', 68, 1.2),
    ('Хабаровский край', 75, 1.2),
    ('Амурская область', 65, 1.2),
    ('Архангельская область', 78, 1.2),
    ('Астраханская область', 55, 1.2),
    ('Белгородская область', 68, 1.2),
    ('Брянская область', 75, 1.2),
    ('Владимирская область', 72, 1.2),
    ('Волгоградская область', 60, 1.2),
    ('Вологодская область', 78, 1.2),
    ('Воронежская область', 65, 1.2),
    ('Ивановская область', 75, 1.2),
    ('Иркутская область', 60, 1.2),
    ('Калининградская область', 80, 1.3),
    ('Калужская область', 72, 1.2),
    ('Камчатский край', 80, 1.2),
    ('Кемеровская область — Кузбасс', 65, 1.2),
    ('Кировская область', 72, 1.2),
    ('Костромская область', 75, 1.2),
    ('Курганская область', 65, 1.2),
    ('Курская область', 68, 1.2),
    ('Липецкая область', 68, 1.2),
    ('Магаданская область', 78, 1.2),
    ('Мурманская область', 80, 1.2),
    ('Нижегородская область', 70, 1.2),
    ('Новгородская область', 78, 1.2),
    ('Новосибирская область', 60, 1.2),
    ('Омская область', 60, 1.2),
    ('Оренбургская область', 60, 1.2),
    ('Орловская область', 72, 1.2),
    ('Пензенская область', 68, 1.2),
    ('Пермский край', 72, 1.2),
    ('Псковская область', 78, 1.2),
    ('Ростовская область', 60, 1.2),
    ('Рязанская область', 72, 1.2),
    ('Самарская область', 65, 1.2),
    ('Саратовская область', 60, 1.2),
    ('Сахалинская область', 85, 1.2),
    ('Свердловская область', 65, 1.2),
    ('Смоленская область', 75, 1.2),
    ('Тамбовская область', 65, 1.2),
    ('Тверская область', 75, 1.2),
    ('Томская область', 70, 1.2),
    ('Тульская область', 70, 1.2),
    ('Тюменская область', 70, 1.2),
    ('Ульяновская область', 65, 1.2),
    ('Челябинская область', 65, 1.2),
    ('Забайкальский край', 55, 1.2),
    ('Ярославская область', 75, 1.2),
    ('Еврейская автономная область', 70, 1.2),
    ('Ненецкий автономный округ', 80, 1.2),
    ('Ханты-Мансийский автономный округ — Югра', 75, 1.2),
    ('Чукотский автономный округ', 78, 1.2),
    ('Ямало-Ненецкий автономный округ', 78, 1.2),
    ('Донецкая Народная Республика', 65, 1.2),
    ('Луганская Народная Республика', 65, 1.2),
    ('Запорожская область', 65, 1.2),
    ('Херсонская область', 65, 1.2)
) AS m(name_ru, humidity, price)
ON m.name_ru = r.name_ru
ON CONFLICT (region_id) DO UPDATE
SET avg_annual_humidity = EXCLUDED.avg_annual_humidity,
    avg_water_price_usd_1l = EXCLUDED.avg_water_price_usd_1l,
    updated_at = now();

COMMIT;

